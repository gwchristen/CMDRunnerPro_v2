<UserControl
    x:Class="CmdRunnerPro.Views.TemplateEditor"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:md="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:util="clr-namespace:CmdRunnerPro.Utilities">

    <!-- Keyboard shortcuts to close dialog -->
    <UserControl.InputBindings>
        <KeyBinding Key="Escape"
                    Command="{x:Static md:DialogHost.CloseDialogCommand}"
                    CommandParameter="Cancel"/>
        <KeyBinding Key="Enter" Modifiers="Control"
                    Command="{x:Static md:DialogHost.CloseDialogCommand}"
                    CommandParameter="{Binding}"/>
    </UserControl.InputBindings>

    <Grid Margin="24" md:ValidationAssist.UsePopup="True">
        <!-- Two columns: Quick Add | Editor -->
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="320"/>
            <ColumnDefinition Width="600"/>
        </Grid.ColumnDefinitions>

        <!-- Two rows: Content | Footer -->
        <Grid.RowDefinitions>
            <RowDefinition/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- ===================== LEFT: QUICK ADD ===================== -->
        <Border Grid.Column="0" Grid.Row="0" Margin="0,0,16,0" Padding="12"
                BorderThickness="1" CornerRadius="4"
                BorderBrush="{DynamicResource MaterialDesignDivider}">
            <DockPanel LastChildFill="True">
                <StackPanel DockPanel.Dock="Top">
                    <TextBlock Text="Quick Add" FontWeight="SemiBold" Margin="0,0,0,8" />

                    <Expander Header="Quick Add Tokens"
                              IsExpanded="{Binding IsQuickAddTokensExpanded, Mode=TwoWay}"
                              Margin="0,0,0,8">

                        <!-- Controls row -->
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,8">
                                <!-- NOTE: escape braces with {} so it's literal text -->
                                <ToggleButton
                                    Content="{}Use {Q:...}"
                                    IsChecked="{Binding UseQuotedTokens}"
                                    Style="{DynamicResource MaterialDesignFilterChipToggleButton}"
                                    Margin="0,0,8,0" />
                                <CheckBox Content="Auto-quote tokens when needed"
                                          IsChecked="{Binding UseQuotedTokens}"
                                          VerticalAlignment="Center" />
                            </StackPanel>

                            <!-- Token buttons -->
                            <WrapPanel>
                                <Button Content="COM1" Margin="0,0,8,8"
                                        Command="{Binding AddTokenCommand}" CommandParameter="comport1" />
                                <Button Content="COM2" Margin="0,0,8,8"
                                        Command="{Binding AddTokenCommand}" CommandParameter="comport2" />
                                <Button Content="Username" Margin="0,0,8,8"
                                        Command="{Binding AddTokenCommand}" CommandParameter="username" />
                                <Button Content="Password" Margin="0,0,8,8"
                                        Command="{Binding AddTokenCommand}" CommandParameter="password" />
                                <Button Content="Opco" Margin="0,0,8,8"
                                        Command="{Binding AddTokenCommand}" CommandParameter="opco" />
                                <Button Content="Program" Margin="0,0,8,8"
                                        Command="{Binding AddTokenCommand}" CommandParameter="program" />
                                <Button Content="WD" Margin="0,0,8,8"
                                        Command="{Binding AddTokenCommand}" CommandParameter="wd" />
                            </WrapPanel>
                        </StackPanel>
                    </Expander>
                </StackPanel>

                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding QuickAddCategories}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Expander IsExpanded="{Binding IsExpanded, Mode=TwoWay}" Margin="0,0,0,8">
                                    <Expander.Header>
                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                    </Expander.Header>

                                    <!-- Snippets list -->
                                    <ItemsControl ItemsSource="{Binding Items}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Button Margin="0,0,0,6"
                                                        HorizontalContentAlignment="Left"
                                                        Content="{Binding Name}"
                                                        ToolTip="{Binding Description}"
                                                        Command="{Binding DataContext.AddSnippetCommand,
                                                                          RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Expander>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </DockPanel>
        </Border>

        <!-- ===================== RIGHT: MAIN EDITOR ===================== -->
        <ScrollViewer Grid.Column="1" Grid.Row="0" VerticalScrollBarVisibility="Auto">
            <StackPanel Orientation="Vertical" Margin="0,0,0,16">
                <ComboBox
                    Width="360"
                    ItemsSource="{Binding Templates}"
                    SelectedItem="{Binding SelectedTemplate, Mode=TwoWay}"
                    DisplayMemberPath="Name"
                    IsEditable="False"
                    MaxDropDownHeight="300"
                    Style="{StaticResource MaterialDesignOutlinedComboBox}"
                    md:HintAssist.Hint="Templates" />

                <!-- Action buttons (optional) -->
                <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                    <Button Content="New"
                            Command="{Binding NewTemplateCommand}"
                            Style="{StaticResource MaterialDesignOutlinedButton}" />
                    <Button Content="Edit" Margin="8,0,0,0"
                            Command="{Binding EditTemplateCommand}"
                            Style="{StaticResource MaterialDesignOutlinedButton}" />
                    <Button Content="Delete" Margin="8,0,0,0"
                            Command="{Binding DeleteTemplateCommand}"
                            Style="{StaticResource MaterialDesignOutlinedButton}"
                            Foreground="{DynamicResource MaterialDesignValidationErrorBrush}" />
                </StackPanel>

                <!-- Template text -->
                <TextBox
                    Margin="0,12,0,0"
                    md:HintAssist.Hint="Template Text (supports tokens like {comport1}, {username}, {Q:program})"
                    AcceptsReturn="True"
                    TextWrapping="Wrap"
                    Height="140"
                    VerticalScrollBarVisibility="Auto"
                    Text="{Binding Template, UpdateSourceTrigger=PropertyChanged, ValidatesOnNotifyDataErrors=True, NotifyOnValidationError=True}"/>

                <!-- Raw template preview (tokens intact) -->
                <GroupBox Header="Template (raw / token expression)" Margin="0,16,0,0">
                    <TextBox Text="{Binding Template, Mode=OneWay}"
                             FontFamily="Consolas"
                             FontSize="12"
                             IsReadOnly="True"
                             BorderThickness="0"
                             Background="Transparent"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             VerticalScrollBarVisibility="Auto"/>
                </GroupBox>
            </StackPanel>
        </ScrollViewer>

        <!-- ============================ FOOTER (fixed) ============================ -->
        <DockPanel Grid.Row="1" Grid.ColumnSpan="2" LastChildFill="False" Margin="0,16,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <!-- Delete (danger) -->
                <Button Content="Delete"
                        Command="{Binding DeleteCommand}"
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        Foreground="{DynamicResource MaterialDesignValidationErrorBrush}"
                        ToolTip="Delete this template" />

                <!-- Save As... -->
                <Button Content="Save As..."
                        Margin="8,0,0,0"
                        Command="{Binding SaveAsCommand}"
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        ToolTip="Create a copy with a new name" />

                <!-- Save -->
                <Button Content="Save"
                        Margin="8,0,0,0"
                        Command="{Binding SaveCommand}"
                        Style="{StaticResource MaterialDesignRaisedButton}"
                        ToolTip="Save changes" />

                <!-- Cancel -->
                <Button Content="Cancel"
                        Margin="8,0,0,0"
                        Command="{x:Static md:DialogHost.CloseDialogCommand}"
                        Style="{StaticResource MaterialDesignOutlinedButton}" />
            </StackPanel>
        </DockPanel>

    </Grid>
</UserControl>